<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sanicare — Sanitary Ware Demo (Updated Checkout)</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<style>
  :root{
    --brand:#0ea5a3; --ink:#0f172a; --muted:#64748b; --bg:#f7fbfb; --card:#fff;
    --line:#eaeef2; --ring:#b2f1f0; --ok:#065f46; --danger:#b91c1c; --accent:#0d6efd;
    --shadow:0 10px 24px rgba(17,24,39,.06);
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink);background:var(--bg)}
  a{color:var(--accent);text-decoration:none}
  .container{max-width:1100px;margin:auto;padding:0 20px}
  header{position:sticky;top:0;z-index:40;background:rgba(255,255,255,.9);backdrop-filter:blur(8px);border-bottom:1px solid var(--line)}
  .nav{display:flex;align-items:center;justify-content:space-between;height:64px}
  .brand{display:flex;gap:10px;align-items:center;font-weight:800}
  .brand .logo{width:36px;height:36px;border-radius:9px;background:linear-gradient(135deg,var(--brand),#34d399);
    display:grid;place-items:center;color:#fff;box-shadow:0 6px 20px rgba(14,165,163,.35)}
  .btn{display:inline-flex;gap:8px;align-items:center;justify-content:center;padding:10px 14px;border-radius:10px;border:1px solid transparent;font-weight:600;cursor:pointer}
  .btn-primary{background:var(--brand);color:#fff}
  .btn-muted{background:#f3f4f6;color:#111827}
  .btn-outline{border:1px solid var(--brand);color:var(--brand);background:#fff}
  .input{width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);background:#fff}
  .input:focus{outline:none;box-shadow:0 0 0 4px var(--ring)}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow)}
  .section{padding:28px 0}
  .hero{padding:40px 0 24px;background:
    radial-gradient(1200px 400px at 60% -10%, #e6fffe 10%, transparent 45%),
    linear-gradient(180deg,#fff, #f9ffff 50%, #f4fffe)}
  .hero-wrap{display:grid;grid-template-columns:1.2fr 1fr;gap:28px;align-items:center}
  .pill{padding:6px 10px;border-radius:20px;background:#eefaf9;color:#0f766e;font-size:12px}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin:10px 0 16px}
  .catalog{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
  .product{display:flex;flex-direction:column;padding:14px}
  .thumb{aspect-ratio:4/3;border-radius:12px;background:#f1f5f9;display:grid;place-items:center;overflow:hidden;border:1px solid var(--line)}
  .thumb img{width:100%;height:100%;object-fit:cover}
  .title{font-weight:700;margin-top:10px}
  .price{color:#0f766e;font-weight:700}
  .grid{display:grid;gap:16px}
  .form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}

  /* Drawer (cart) */
  .drawer{position:fixed;top:0;right:-440px;width:380px;height:100vh;background:#fff;border-left:1px solid var(--line);
    box-shadow:-10px 0 30px rgba(0,0,0,.08);transition:right .28s ease;z-index:50;display:flex;flex-direction:column}
  .drawer.open{right:0}
  .drawer .content{padding:16px;overflow:auto;flex:1}
  .cart-line{display:grid;grid-template-columns:64px 1fr auto;gap:10px;align-items:center;margin-bottom:12px}
  .cart-line img{width:64px;height:48px;object-fit:cover;border-radius:8px;border:1px solid var(--line)}
  .checkout{border-top:1px solid var(--line);padding:12px;display:grid;gap:10px}

  /* Chat */
  .chatfab{position:fixed;right:18px;bottom:18px;border-radius:999px;background:var(--brand);color:#fff;width:54px;height:54px;display:grid;place-items:center;box-shadow:0 12px 26px rgba(14,165,163,.35);z-index:40;cursor:pointer}
  .chatbox{position:fixed;right:18px;bottom:84px;width:320px;background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:0 20px 50px rgba(2,6,23,.15);display:none;overflow:hidden;z-index:45}
  .chatbox.open{display:grid;grid-template-rows:auto 1fr auto}
  .chat-head{padding:12px 14px;background:linear-gradient(90deg,var(--brand),#22c6bd);color:#fff;font-weight:700}
  .msgs{max-height:280px;overflow:auto;padding:10px 12px;display:grid;gap:8px;background:#f8ffff}
  .bubble{padding:8px 10px;border-radius:12px;max-width:80%}
  .me{justify-self:end;background:#e0fbfa}.them{justify-self:start;background:#fff;border:1px solid var(--line)}
  .chat-input{display:flex;gap:8px;padding:10px;border-top:1px solid var(--line)}
  .chat-input input{flex:1}

  /* Admin */
  .modal{position:fixed;inset:0;background:rgba(2,6,23,.45);display:none;place-items:center;z-index:60}
  .modal.open{display:grid}
  .modal .sheet{width:min(800px,92vw);max-height:80vh;overflow:auto;background:#fff;border-radius:16px;border:1px solid var(--line);padding:16px}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{border-bottom:1px solid var(--line);padding:8px;text-align:left}

  /* --- Redesigned CHECKOUT --- */
  .step-tabs{display:flex;border-bottom:1px solid var(--line);gap:8px}
  .step-tab{padding:12px 14px;border-bottom:3px solid transparent;font-weight:700;color:#64748b;cursor:pointer}
  .step-tab.active{color:#0b1324;border-color:#111}
  .section-title{font-size:18px;font-weight:700;margin:10px 0 6px}
  .option-card{border:1.5px solid var(--line);border-radius:12px;padding:12px;display:flex;gap:12px;align-items:flex-start;background:#fff}
  .option-card:hover{border-color:#cdecec}
  .option-left{display:flex;gap:10px;align-items:center}
  .option-title{font-weight:700}
  .logos{display:flex;gap:8px;align-items:center}
  .logos i{font-size:18px}
  .paymethod{display:grid;gap:8px}
  .pm-body{margin-left:34px;margin-top:8px;display:none}
  .pm-body.open{display:block}
  .row-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
  .secure{display:flex;gap:8px;align-items:center;color:#0f5132;background:#d1e7dd;border:1px solid #badbcc;border-radius:10px;padding:8px 10px;font-size:13px}
  .total-line{display:flex;justify-content:space-between;margin-top:12px;font-weight:700}
  .btn-big{width:100%;padding:14px;border-radius:12px;background:#111;color:#fff;border:none;font-weight:700;cursor:pointer}
  .mini{font-size:12px;color:#475569}
  footer{padding:24px 0;color:#64748b}

  /* Responsive */
  @media (max-width: 960px){ .hero-wrap{grid-template-columns:1fr} .catalog{grid-template-columns:repeat(2,1fr)} }
  @media (max-width: 560px){ .catalog{grid-template-columns:1fr} .form-row,.row-2,.row-3{grid-template-columns:1fr} }
</style>
</head>
<body>
<header>
  <div class="container nav">
    <div class="brand"><div class="logo"><i class="bi bi-droplet-half"></i></div><div>Sanicare <span class="pill">Demo</span></div></div>
    <nav>
      <a href="#lead">Lead Form</a>
      <a href="#shop">Shop</a>
      <a href="#checkout">Checkout</a>
      <a href="#contact">Contact</a>
      <a href="#" id="openAdmin"><i class="bi bi-speedometer2"></i> Admin</a>
      <button class="btn btn-outline" id="openCart"><i class="bi bi-bag"></i> Cart</button>
    </nav>
  </div>
</header>

<section class="hero" id="lead">
  <div class="container hero-wrap">
    <div>
      <span class="pill"><i class="bi bi-lightning-charge"></i> Quick demo • front-end only</span>
      <h1>Sanitary-ware shopping, <span style="color:var(--brand)">with fundi support</span> & easy checkout</h1>
      <p>Collect customer leads, showcase products, chat, and guide checkout with <b>Selcom (mock)</b>. Perfect for a stakeholder preview.</p>
      <div class="card" style="padding:16px">
        <h3 style="margin:4px 0 10px">Lead Form — Jaza taarifa zako</h3>
        <div class="grid">
          <input class="input" id="f_name" placeholder="Jina">
          <div class="form-row">
            <input class="input" id="f_phone" placeholder="Namba ya simu (WhatsApp)">
            <input class="input" id="f_email" placeholder="Email">
          </div>
          <div class="form-row">
            <input class="input" id="f_location" placeholder="Eneo la ujenzi wako">
            <input class="input" id="f_bath" placeholder="Idadi ya bafu/choo">
          </div>
          <button class="btn btn-primary" id="saveLead"><i class="bi bi-check2-circle"></i> Hifadhi Taarifa</button>
          <div class="mini" id="leadMsg"></div>
        </div>
      </div>
    </div>
    <div class="card" style="padding:0;overflow:hidden">
      <img src="https://images.unsplash.com/photo-1523419409543-888d6b4073cb?w=1200&q=60" alt="bath" style="width:100%;display:block">
      <div class="mini" style="padding:8px 12px">Demo image • Products below are dummy data. All prices in <b>TZS</b>.</div>
    </div>
  </div>
</section>

<section class="section" id="shop">
  <div class="container">
    <h2>Shop Sanitary Ware</h2>
    <div class="mini">Toilets, basins, mixers, showers, and accessories.</div>
    <div class="toolbar">
      <input class="input" style="flex:1;min-width:220px" id="q" placeholder="Search (e.g., 'toilet', 'mixer', 'shower')">
      <div style="display:flex;gap:8px">
        <select class="input" id="cat" style="width:180px">
          <option value="">All categories</option>
          <option>Toilets</option><option>Basins</option><option>Mixers</option>
          <option>Showers</option><option>Accessories</option>
        </select>
        <button class="btn btn-muted" id="reset"><i class="bi bi-x-circle"></i> Reset</button>
      </div>
    </div>
    <div class="catalog" id="catalog"></div>
  </div>
</section>

<!-- ********** NEW CHECKOUT ********** -->
<section class="section" id="checkout">
  <div class="container">
    <h2>Checkout</h2>
    <div class="grid" style="grid-template-columns:1.2fr 1fr">
      <!-- Left: Steps -->
      <div class="card" style="padding:0">
        <div style="padding:16px 16px 0">
          <div class="step-tabs">
            <div class="step-tab active" data-step="shipping">Shipping</div>
            <div class="step-tab" data-step="payment">Payment</div>
            <div class="step-tab" data-step="review">Review</div>
          </div>
        </div>
        <div style="padding:16px">
          <!-- Step: Shipping -->
          <div class="step" id="step-shipping">
            <div class="section-title">Delivery Details</div>
            <div class="row-2">
              <input class="input" id="c_name" placeholder="Full Name">
              <input class="input" id="c_phone" placeholder="Phone (WhatsApp)">
            </div>
            <div class="row-2">
              <input class="input" id="c_address" placeholder="Delivery Address">
              <input class="input" id="c_city" placeholder="City / Region">
            </div>
            <div class="grid">
              <label style="display:flex;align-items:center;gap:8px;margin-top:6px">
                <input type="checkbox" id="needFundi" /> <span>Need a Fundi / Installer?</span>
              </label>
              <div id="fundiExtra" class="row-2" style="display:none">
                <input class="input" id="fu_location" placeholder="Work Location">
                <input class="input" id="fu_time" placeholder="Preferred Time (e.g., Sat 10:00)">
              </div>
              <button class="btn-big" id="toPayment">Continue</button>
            </div>
          </div>

          <!-- Step: Payment -->
          <div class="step" id="step-payment" style="display:none">
            <div class="section-title">Choose a payment option</div>
            <div class="mini" style="margin-bottom:8px">You will review all details on the next step.</div>

            <div class="paymethod">
              <!-- Mobile Money -->
              <label class="option-card">
                <input type="radio" name="pay" value="mobile" style="margin-top:4px" checked>
                <div class="option-left">
                  <div class="option-title">Mobile Money</div>
                </div>
                <div class="logos" style="margin-left:auto">
                  <img alt="mpesa" src="https://upload.wikimedia.org/wikipedia/commons/7/76/M-PESA_LOGO.svg" style="height:18px">
                  <img alt="tigo" src="https://upload.wikimedia.org/wikipedia/commons/c/c2/Tigo_logo.svg" style="height:18px">
                  <img alt="airtel" src="https://upload.wikimedia.org/wikipedia/commons/0/0e/Airtel_logo_2015.svg" style="height:18px">
                </div>
              </label>
              <div class="pm-body open" id="pm-mobile">
                <div class="row-3">
                  <select class="input" id="mm_provider">
                    <option>M-Pesa</option><option>Tigo Pesa</option><option>Airtel Money</option>
                  </select>
                  <input class="input" id="mm_phone" placeholder="Phone number">
                  <input class="input" id="mm_ref" placeholder="Reference (auto on Selcom) — demo">
                </div>
                <div class="mini" style="margin-top:6px">Fee hint: ~1% (incl. VAT) on merchant side in production.</div>
              </div>

              <!-- Cards -->
              <label class="option-card">
                <input type="radio" name="pay" value="card" style="margin-top:4px">
                <div class="option-left"><div class="option-title">Card</div></div>
                <div class="logos" style="margin-left:auto">
                  <i class="bi bi-cc-visa"></i><i class="bi bi-cc-mastercard"></i>
                </div>
              </label>
              <div class="pm-body" id="pm-card">
                <div class="row-2">
                  <input class="input" id="card_name" placeholder="Name on card">
                  <input class="input" id="card_number" placeholder="Card number">
                </div>
                <div class="row-3">
                  <input class="input" id="card_exp" placeholder="MM / YYYY">
                  <input class="input" id="card_cvv" placeholder="CVV">
                  <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="sameBill"> My billing and shipping address same</label>
                </div>
              </div>

              <!-- Banks -->
              <label class="option-card">
                <input type="radio" name="pay" value="bank" style="margin-top:4px">
                <div class="option-left"><div class="option-title">Bank (CRDB / NMB)</div></div>
                <div class="logos" style="margin-left:auto"><span class="pill">CRDB</span><span class="pill">NMB</span></div>
              </label>
              <div class="pm-body" id="pm-bank">
                <div class="row-3">
                  <select class="input" id="bank_name"><option>CRDB</option><option>NMB</option></select>
                  <input class="input" id="bank_acc" placeholder="Account Number (demo)">
                  <input class="input" id="bank_ref" placeholder="Reference">
                </div>
                <div class="mini" style="margin-top:6px">Bank transfer simulated for demo. In production, Selcom handles card/mobile; bank rails configurable.</div>
              </div>
            </div>

            <div class="secure" style="margin-top:10px"><i class="bi bi-shield-lock"></i> Secure demo • No real payments processed</div>
            <button class="btn-big" id="toReview">Continue</button>
          </div>

          <!-- Step: Review -->
          <div class="step" id="step-review" style="display:none">
            <div class="section-title">Review your order</div>
            <div id="reviewBlock" class="grid"></div>
            <button class="btn-big" id="placeOrder"><i class="bi bi-bag-check"></i> Place Order (Mock)</button>
            <div class="mini" id="orderMsg"></div>
          </div>
        </div>
      </div>

      <!-- Right: Summary -->
      <div class="card" style="padding:16px">
        <h3 style="margin:6px 0 10px">Order Summary</h3>
        <div id="summary"></div>
        <div class="total-line"><div>Subtotal</div><div id="summarySubtotal">TZS 0</div></div>
        <div class="total-line"><div>Shipping</div><div>Free</div></div>
        <div class="total-line"><div>Total</div><div id="summaryTotal">TZS 0</div></div>
        <div class="mini" style="margin-top:8px">Default production gateway: <b>Selcom</b> (Mobile Money & Cards). Alternative (e.g., Azam Pay) possible.</div>
      </div>
    </div>
  </div>
</section>
<!-- ********** END NEW CHECKOUT ********** -->

<section class="section" id="contact">
  <div class="container grid" style="grid-template-columns:1fr 1fr">
    <div class="card" style="padding:16px">
      <h3>Contact Us</h3>
      <div class="grid">
        <input class="input" placeholder="Your Email">
        <input class="input" placeholder="Subject">
        <textarea class="input" rows="4" placeholder="Message"></textarea>
        <button class="btn btn-outline"><i class="bi bi-send"></i> Send (mock)</button>
      </div>
      <div class="mini" style="margin-top:8px">
        <i class="bi bi-telephone"></i> +255 7XX XXX XXX • <i class="bi bi-envelope"></i> hello@sanicare.tz
      </div>
    </div>
    <div class="card" style="padding:16px">
      <h3>FAQ</h3>
      <details open><summary>Do you deliver nationwide?</summary><div class="mini">Yes — demo text. Real coverage depends on logistics partner.</div></details>
      <details><summary>Which payments are supported?</summary><div class="mini">Selcom (Mobile Money & Cards) in production. This demo uses mock checkout.</div></details>
      <details><summary>Can I request a fundi/installer?</summary><div class="mini">Yes, enable the Fundi option in Shipping.</div></details>
    </div>
  </div>
</section>

<footer><div class="container">© <span id="yr"></span> Sanicare Demo. For evaluation only.</div></footer>

<!-- Drawer Cart -->
<aside class="drawer" id="drawer">
  <div class="nav container" style="height:56px">
    <div style="font-weight:800"><i class="bi bi-bag"></i> Your Cart</div>
    <button class="btn btn-muted" id="closeCart"><i class="bi bi-x-lg"></i> Close</button>
  </div>
  <div class="content" id="cartLines"></div>
  <div class="checkout">
    <div style="display:flex;justify-content:space-between"><div>Subtotal</div><div id="cartSubtotal">TZS 0</div></div>
    <button class="btn btn-primary" onclick="document.querySelector('#drawer').classList.remove('open');document.querySelector('#checkout').scrollIntoView({behavior:'smooth'});"><i class="bi bi-credit-card"></i> Go to Checkout</button>
  </div>
</aside>

<!-- Chat -->
<div class="chatfab" id="chatFab"><i class="bi bi-chat-dots"></i></div>
<div class="chatbox" id="chatBox">
  <div class="chat-head"><i class="bi bi-headset"></i> Chat Support</div>
  <div class="msgs" id="msgs"><div class="bubble them">Habari! Karibu Sanicare. Tunawezaje kukusaidia?</div></div>
  <div class="chat-input">
    <input class="input" id="chatInput" placeholder="Andika ujumbe...">
    <button class="btn btn-primary" id="chatSend"><i class="bi bi-arrow-right"></i></button>
  </div>
</div>

<!-- Admin Modal -->
<div class="modal" id="adminModal">
  <div class="sheet">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h3 style="margin:0">Admin Preview (Mock)</h3>
      <button class="btn btn-muted" id="closeAdmin"><i class="bi bi-x"></i> Close</button>
    </div>
    <h4 style="margin:8px 0 4px">Captured Leads</h4>
    <table class="table" id="leadTable">
      <thead><tr><th>Name</th><th>Phone</th><th>Email</th><th>Location</th><th>Baths</th></tr></thead><tbody></tbody>
    </table>
    <h4 style="margin:12px 0 4px">Orders (last session)</h4>
    <table class="table" id="orderTable">
      <thead><tr><th>Customer</th><th>Phone</th><th>Total (TZS)</th><th>Payment</th><th>Fundi?</th></tr></thead><tbody></tbody>
    </table>
  </div>
</div>

<script>
  /* ------------ Dummy Products (TZS) ------------ */
  const PRODUCTS = [
    {id:1, name:"EcoFlush Toilet (Dual-Flush)", cat:"Toilets", price: 320000, img:"https://images.unsplash.com/photo-1617093727343-e670bdc0b70b?w=800&q=60"},
    {id:2, name:"Slim Basin Sink 55cm", cat:"Basins", price: 180000, img:"https://images.unsplash.com/photo-1600566752355-35792bedcfea?w=800&q=60"},
    {id:3, name:"Chrome Basin Mixer", cat:"Mixers", price: 145000, img:"https://images.unsplash.com/photo-1598300183690-e21d3b496af2?w=800&q=60"},
    {id:4, name:"Rain Shower Set", cat:"Showers", price: 420000, img:"https://images.unsplash.com/photo-1574643156920-59f39326aef8?w=800&q=60"},
    {id:5, name:"Concealed Cistern", cat:"Accessories", price: 260000, img:"https://images.unsplash.com/photo-1633158829585-23ba8f7c8cac?w=800&q=60"},
    {id:6, name:"Wall-Hung Toilet", cat:"Toilets", price: 540000, img:"https://images.unsplash.com/photo-1564540574859-0dfb639859cd?w=800&q=60"},
    {id:7, name:"Countertop Basin 45cm", cat:"Basins", price: 210000, img:"https://images.unsplash.com/photo-1621786036699-f6c2cd4b2e9d?w=800&q=60"},
    {id:8, name:"Thermostatic Shower Mixer", cat:"Mixers", price: 390000, img:"https://images.unsplash.com/photo-1619158401201-bc58c37e4c38?w=800&q=60"},
  ];
  const TZS = n => "TZS " + n.toLocaleString("en-TZ");
  const getStore = (k,f)=>JSON.parse(localStorage.getItem(k)||JSON.stringify(f));
  const setStore = (k,v)=>localStorage.setItem(k,JSON.stringify(v));

  /* ------------ Lead ------------ */
  const leadKeys=["f_name","f_phone","f_email","f_location","f_bath"];
  function saveLead(){
    const lead=Object.fromEntries(leadKeys.map(id=>[id.replace("f_",""),document.getElementById(id).value.trim()]));
    const leads=getStore("leads",[]);
    if(!lead.name||!lead.phone){toast("leadMsg","Tafadhali weka angalau Jina na Simu.",true);return;}
    leads.push({...lead,ts:Date.now()}); setStore("leads",leads);
    toast("leadMsg","Asante! Taarifa zimehifadhiwa."); document.getElementById("c_name").value=lead.name; document.getElementById("c_phone").value=lead.phone;
  }
  function toast(id,text,err){const m=document.getElementById(id);m.textContent=text;m.style.color=err?"#b91c1c":"#065f46";setTimeout(()=>m.textContent="",4000);}

  /* ------------ Catalog + Cart ------------ */
  let CART=getStore("cart",[]);
  function renderCatalog(list=PRODUCTS){
    const root=document.getElementById("catalog"); root.innerHTML="";
    list.forEach(p=>{
      const card=document.createElement("div"); card.className="card product";
      card.innerHTML=`
        <div class="thumb"><img src="${p.img}" alt="${p.name}"></div>
        <div class="title">${p.name}</div>
        <div class="mini">${p.cat}</div>
        <div style="display:flex;align-items:center;justify-content:space-between;margin-top:6px">
          <div class="price">${TZS(p.price)}</div>
          <div><button class="btn btn-muted" onclick="addToCart(${p.id})"><i class="bi bi-bag-plus"></i> Add</button></div>
        </div>`;
      root.appendChild(card);
    });
  }
  function addToCart(id){
    const p=PRODUCTS.find(x=>x.id===id);
    const e=CART.find(i=>i.id===id);
    if(e) e.qty+=1; else CART.push({id:p.id,name:p.name,price:p.price,img:p.img,qty:1});
    setStore("cart",CART); renderCart();
  }
  function renderCart(){
    const lines=document.getElementById("cartLines"); lines.innerHTML="";
    let subtotal=0;
    CART.forEach((it,ix)=>{
      subtotal+=it.price*it.qty;
      const row=document.createElement("div"); row.className="cart-line";
      row.innerHTML=`
        <img src="${it.img}" alt="${it.name}">
        <div>
          <div style="font-weight:600">${it.name}</div>
          <div class="mini">${TZS(it.price)} • Qty
            <button class="btn btn-muted" style="padding:2px 8px" onclick="cartQty(${ix},-1)"><i class="bi bi-dash"></i></button>
            ${it.qty}
            <button class="btn btn-muted" style="padding:2px 8px" onclick="cartQty(${ix},1)"><i class="bi bi-plus"></i></button>
          </div>
        </div>
        <div>
          <div style="text-align:right">${TZS(it.price*it.qty)}</div>
          <button class="btn btn-muted" style="margin-top:6px" onclick="removeLine(${ix})"><i class="bi bi-trash"></i></button>
        </div>`;
      lines.appendChild(row);
    });
    document.getElementById("cartSubtotal").textContent=TZS(subtotal);
    const sum=document.getElementById("summary"); sum.innerHTML="";
    CART.forEach(it=>{
      const d=document.createElement("div");
      d.style="display:flex;justify-content:space-between;margin-bottom:6px";
      d.innerHTML=`<div>${it.name} × ${it.qty}</div><div>${TZS(it.price*it.qty)}</div>`;
      sum.appendChild(d);
    });
    document.getElementById("summarySubtotal").textContent=TZS(subtotal);
    document.getElementById("summaryTotal").textContent=TZS(subtotal);
    buildReview();
  }
  function cartQty(ix,delta){CART[ix].qty+=delta;if(CART[ix].qty<1)CART.splice(ix,1);setStore("cart",CART);renderCart();}
  function removeLine(ix){CART.splice(ix,1);setStore("cart",CART);renderCart();}
  function applyFilter(){
    const q=document.getElementById("q").value.toLowerCase(); const cat=document.getElementById("cat").value;
    renderCatalog(PRODUCTS.filter(p=>(!q||p.name.toLowerCase().includes(q))&&(!cat||p.cat===cat)));
  }

  /* ------------ New Checkout Steps ------------ */
  function showStep(step){
    document.querySelectorAll(".step-tab").forEach(t=>t.classList.toggle("active",t.dataset.step===step));
    document.getElementById("step-shipping").style.display = step==="shipping"?"block":"none";
    document.getElementById("step-payment").style.display = step==="payment"?"block":"none";
    document.getElementById("step-review").style.display = step==="review"?"block":"none";
  }
  function currentPaySummary(){
    const val=document.querySelector('input[name="pay"]:checked')?.value;
    if(val==="card") return "Card • (mock details)";
    if(val==="bank") return `Bank • ${document.getElementById("bank_name").value}`;
    return `Mobile Money • ${document.getElementById("mm_provider").value}`;
  }
  function buildReview(){
    const block=document.getElementById("reviewBlock"); if(!block) return;
    const total=CART.reduce((a,c)=>a+c.price*c.qty,0);
    const name=document.getElementById("c_name")?.value||"";
    const phone=document.getElementById("c_phone")?.value||"";
    const addr=document.getElementById("c_address")?.value||"";
    const city=document.getElementById("c_city")?.value||"";
    const fundi=document.getElementById("needFundi")?.checked;
    block.innerHTML=`
      <div class="card" style="padding:12px">
        <div class="section-title">Items</div>
        ${CART.map(i=>`<div style="display:flex;justify-content:space-between"><div>${i.name} × ${i.qty}</div><div>${TZS(i.price*i.qty)}</div></div>`).join("")}
        <div class="total-line"><div>Total</div><div>${TZS(total)}</div></div>
      </div>
      <div class="card" style="padding:12px">
        <div class="section-title">Shipping</div>
        <div>${name} • ${phone}</div>
        <div class="mini">${addr}, ${city}</div>
        <div class="mini">${fundi?"Fundi requested ✓":"No fundi requested"}</div>
      </div>
      <div class="card" style="padding:12px">
        <div class="section-title">Payment</div>
        <div id="reviewPay">${currentPaySummary()}</div>
      </div>`;
  }
  function updatePM(){
    const val=document.querySelector('input[name="pay"]:checked').value;
    document.getElementById("pm-mobile").classList.toggle("open",val==="mobile");
    document.getElementById("pm-card").classList.toggle("open",val==="card");
    document.getElementById("pm-bank").classList.toggle("open",val==="bank");
    buildReview();
  }
  function placeOrder(){
    if(CART.length===0){document.getElementById("orderMsg").textContent="Your cart is empty.";document.getElementById("orderMsg").style.color="#b91c1c";return;}
    const name=document.getElementById("c_name").value.trim();
    const phone=document.getElementById("c_phone").value.trim();
    if(!name||!phone){document.getElementById("orderMsg").textContent="Please add Name & Phone.";document.getElementById("orderMsg").style.color="#b91c1c";return;}
    const payment=document.querySelector('input[name="pay"]:checked').value;
    const fundi=document.getElementById("needFundi").checked;
    const total=CART.reduce((a,c)=>a+c.price*c.qty,0);
    const orders=getStore("orders",[]);
    orders.push({name,phone,total,payment,fundi,ts:Date.now()}); setStore("orders",orders);
    CART=[]; setStore("cart",CART); renderCart();
    document.getElementById("orderMsg").textContent="Order placed (mock). In production, Selcom checkout would start now.";
    document.getElementById("orderMsg").style.color="#065f46";
    showStep("shipping"); window.scrollTo({top:0,behavior:"smooth"});
  }

  /* ------------ Chat & Admin ------------ */
  function addMsg(text,me=false){const w=document.createElement("div"); w.className="bubble "+(me?"me":"them"); w.textContent=text;
    document.getElementById("msgs").appendChild(w); const b=document.getElementById("msgs"); b.scrollTop=b.scrollHeight;}
  function botReply(q){const t=q.toLowerCase();
    if(t.includes("bei")||t.includes("price"))return"Bidhaa zetu zipo kuanzia TZS 145,000 hadi 540,000.";
    if(t.includes("delivery"))return"Tunasafirisha kwenye mikoa mingi — gharama hutegemea eneo.";
    if(t.includes("fundi"))return"Ndiyo, unaweza kuchagua Fundi kwenye sehemu ya Shipping.";
    return"Asante kwa ujumbe! Tutakujibu mara tu.";}

  /* ------------ Events ------------ */
  document.getElementById("saveLead").addEventListener("click",saveLead);
  document.getElementById("openCart").addEventListener("click",()=>document.getElementById("drawer").classList.add("open"));
  document.getElementById("closeCart").addEventListener("click",()=>document.getElementById("drawer").classList.remove("open"));
  document.getElementById("q").addEventListener("input",applyFilter);
  document.getElementById("cat").addEventListener("change",applyFilter);
  document.getElementById("reset").addEventListener("click",()=>{document.getElementById("q").value="";document.getElementById("cat").value="";applyFilter();});
  document.getElementById("needFundi").addEventListener("change",e=>{document.getElementById("fundiExtra").style.display=e.target.checked?"grid":"none";});
  document.querySelectorAll(".step-tab").forEach(t=>t.addEventListener("click",()=>showStep(t.dataset.step)));
  document.getElementById("toPayment").addEventListener("click",()=>showStep("payment"));
  document.getElementById("toReview").addEventListener("click",()=>{buildReview();showStep("review");});
  document.getElementsByName("pay").forEach(r=>r.addEventListener("change",updatePM));
  ["mm_provider","bank_name"].forEach(id=>document.getElementById(id).addEventListener("change",buildReview));
  document.getElementById("placeOrder").addEventListener("click",placeOrder);
  document.getElementById("chatFab").addEventListener("click",()=>document.getElementById("chatBox").classList.toggle("open"));
  document.getElementById("chatSend").addEventListener("click",()=>{const i=document.getElementById("chatInput");const v=i.value.trim();if(!v)return;addMsg(v,true);i.value="";setTimeout(()=>addMsg(botReply(v),false),500);});
  document.getElementById("openAdmin").addEventListener("click",(e)=>{e.preventDefault(); openAdmin();});
  document.getElementById("closeAdmin").addEventListener("click",()=>document.getElementById("adminModal").classList.remove("open"));
  function openAdmin(){
    const leads=getStore("leads",[]), orders=getStore("orders",[]);
    const tb=document.querySelector("#leadTable tbody"); tb.innerHTML="";
    leads.slice(-50).reverse().forEach(l=>{const tr=document.createElement("tr"); tr.innerHTML=`<td>${l.name||""}</td><td>${l.phone||""}</td><td>${l.email||""}</td><td>${l.location||""}</td><td>${l.bath||""}</td>`; tb.appendChild(tr);});
    const tb2=document.querySelector("#orderTable tbody"); tb2.innerHTML="";
    orders.slice(-50).reverse().forEach(o=>{const tr=document.createElement("tr"); tr.innerHTML=`<td>${o.name}</td><td>${o.phone}</td><td>${o.total.toLocaleString("en-TZ")}</td><td>${o.payment}</td><td>${o.fundi?"Yes":"No"}</td>`; tb2.appendChild(tr);});
    document.getElementById("adminModal").classList.add("open");
  }

  document.getElementById("yr").textContent=new Date().getFullYear();

  /* ------------ Init ------------ */
  renderCatalog(); renderCart(); updatePM();
</script>
</body>
</html>
